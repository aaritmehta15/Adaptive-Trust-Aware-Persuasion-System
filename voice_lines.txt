6: from fastapi import FastAPI, HTTPException, WebSocket
15: from src.voice_agent import VoiceAgent
16: from google.adk.runners import LiveRequestQueue
38: voice_agent = None
87:     # Initialize Voice Agent (Voice Mode)
89:         global voice_agent
90:         voice_agent = VoiceAgent()
91:         print("âœ“ Voice Agent initialized")
101:         print(f"âœ— Voice Agent initialization failed: {e}")
290: @app.websocket("/ws/voice/{session_id}")
291: async def voice_websocket(websocket: WebSocket, session_id: str):
293:     WebSocket Endpoint for ADK Voice (Bidirectional).
303:     actual_session_id = voice_agent.generate_session_id()
306:     await websocket.accept()
312:         # â”€â”€ Step 1: Get or Create ADK Session â”€â”€
313:         print(f"ğŸ“¦ Step 1: Getting/Creating ADK Session...")
315:             await voice_agent.get_or_create_session(actual_session_id)
320:             await websocket.send_json({"type": "error", "message": str(e)})
324:         print(f"ğŸ“¦ Step 2: Creating LiveRequestQueue...")
326:             live_queue = LiveRequestQueue()
331:             await websocket.send_json({"type": "error", "message": str(e)})
334:         # â”€â”€ Upstream: Client Mic â†’ ADK Model â”€â”€
338:                 async for message in websocket.iter_text():
360:         # â”€â”€ Downstream: ADK Model â†’ Client Speaker â”€â”€
364:                 async for event in voice_agent.process_stream(actual_session_id, live_queue):
375:                                 await websocket.send_json({
384:                         await websocket.send_json({"type": "interrupted"})
389:                         await websocket.send_json({"type": "turn_complete", "turn_complete": True})
400:         print(f"âŒ CRITICAL voice error: {e}")
405:         await voice_agent.delete_session(actual_session_id)